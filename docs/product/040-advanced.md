---
title: Продвинутое использование
---

# Продвинутое использование

В этом разделе рассматриваются продвинутые сценарии использования библиотеки `autumn-data`.

## Кастомные методы в хранилищах

Помимо автогенерируемых методов запросов, в хранилищах можно определять собственные методы с произвольной логикой:

```1c
&Родитель
Перем ХранилищеСущностей;

// Автогенерируемый метод
&МетодЗапроса
Функция НайтиПоИмениРавно(Имя) Экспорт
    Возврат Неопределено;
КонецФункции

// Кастомный метод с произвольной логикой
Функция НайтиАктивныхПользователейЗаПериод(ДатаНачала, ДатаОкончания) Экспорт
    ОпцииПоиска = Новый ОпцииПоиска()
        .Отбор("Активен", ВидСравнения.Равно, Истина)
        .Отбор("ДатаПоследнейАктивности", ВидСравнения.БольшеИлиРавно, ДатаНачала)
        .Отбор("ДатаПоследнейАктивности", ВидСравнения.МеньшеИлиРавно, ДатаОкончания)
        .СортироватьПо("ДатаПоследнейАктивности", НаправлениеСортировки.Убыв);
    
    Возврат ХранилищеСущностей.Получить(ОпцииПоиска);
КонецФункции

// Метод с бизнес-логикой
Функция СоздатьПользователяСДефолтнымиНастройками(Имя, Email) Экспорт
    НовыйПользователь = Новый Пользователь();
    НовыйПользователь.Имя = Имя;
    НовыйПользователь.Email = Email;
    НовыйПользователь.Активен = Истина;
    НовыйПользователь.ДатаСоздания = ТекущаяДата();
    НовыйПользователь.Роль = "Пользователь";
    
    Возврат ХранилищеСущностей.Создать(НовыйПользователь);
КонецФункции

&ХранилищеСущностей("Пользователь")
Процедура ПриСозданииОбъекта()
КонецПроцедуры
```

## Работа с транзакциями

Для выполнения операций в транзакциях можно использовать методы менеджера сущностей:

```1c
// Получаем менеджер сущностей
МенеджерСущностей = Поделка.НайтиЖелудь("МенеджерСущностей");

// Выполняем операции в транзакции
МенеджерСущностей.НачатьТранзакцию();
Попытка
    ХранилищеПользователей = Поделка.НайтиЖелудь("ХранилищеПользователей");
    ХранилищеЗаказов = Поделка.НайтиЖелудь("ХранилищеЗаказов");
    
    // Создаем пользователя
    НовыйПользователь = Новый Пользователь();
    НовыйПользователь.Имя = "Иван";
    СохраненныйПользователь = ХранилищеПользователей.Создать(НовыйПользователь);
    
    // Создаем заказ для пользователя
    НовыйЗаказ = Новый Заказ();
    НовыйЗаказ.ИдентификаторПользователя = СохраненныйПользователь.Идентификатор;
    НовыйЗаказ.Сумма = 1000;
    ХранилищеЗаказов.Создать(НовыйЗаказ);
    
    МенеджерСущностей.ЗафиксироватьТранзакцию();
Исключение
    МенеджерСущностей.ОтменитьТранзакцию();
    ВызватьИсключение;
КонецПопытки;
```

## Кастомные коннекторы

Можно создавать собственные коннекторы, наследуясь от базовых классов библиотеки `entity`:

```1c
#Использовать entity

&Коннектор
Функция МойКастомныйКоннектор() Экспорт
    Возврат Новый КоннекторБазовый()
        .УстановитьТипБД("МояБД")
        .УстановитьФабрикуЗапросов(Новый ФабрикаЗапросовМояБД());
КонецФункции
```

И использовать его в конфигурации:

```1c
СоветДругогоМастера = Новый СоветДругогоМастера()
    .Деталька("data.ИсточникиДанных", Новый Соответствие()
        .Вставить("ТипКоннектора", "МойКастомныйКоннектор")
        .Вставить("СтрокаСоединения", "CustomConnectionString")
    );
```

## Миграции схемы базы данных

Для управления схемой базы данных можно использовать возможности библиотеки `entity`:

```1c
// Получаем менеджер сущностей
МенеджерСущностей = Поделка.НайтиЖелудь("МенеджерСущностей");

// Создаем таблицы для всех сущностей
МенеджерСущностей.СоздатьТаблицы();

// Или для конкретной сущности
МенеджерСущностей.СоздатьТаблицуДляКласса(Тип("Пользователь"));

// Удаление таблиц
МенеджерСущностей.УдалитьТаблицы();
```

## Логирование запросов

Для отладки можно включить логирование SQL-запросов:

```1c
СоветДругогоМастера = Новый СоветДругогоМастера()
    .Деталька("data.ИсточникиДанных", Новый Соответствие()
        .Вставить("ТипКоннектора", "КоннекторSqlite")
        .Вставить("СтрокаСоединения", "Data Source=database.db")
        .Вставить("ПараметрыКоннектора", Новый Массив()
            .Добавить(Новый Структура("Логирование", Истина))
        )
    );
```

## Оптимизация производительности

### Ленивая загрузка

По умолчанию все связи загружаются лениво. Для принудительной загрузки используйте методы хранилища:

```1c
// Загрузка с вложенными объектами
ОпцииПоиска = Новый ОпцииПоиска()
    .Включить("Заказы")
    .Включить("Роль");

ПользователиСДанными = ХранилищеПользователей.Получить(ОпцииПоиска);
```

### Пакетные операции

Для оптимизации производительности используйте пакетные операции:

```1c
// Создание множества объектов
МассивПользователей = Новый Массив();
Для Индекс = 1 По 1000 Цикл
    НовыйПользователь = Новый Пользователь();
    НовыйПользователь.Имя = "Пользователь" + Индекс;
    МассивПользователей.Добавить(НовыйПользователь);
КонецЦикла;

ХранилищеПользователей.СоздатьПакет(МассивПользователей);
```

## Тестирование

Для тестирования используйте in-memory коннектор:

```1c
// В тестах
СоветДляТестов = Новый СоветДругогоМастера()
    .Деталька("data.ИсточникиДанных", Новый Соответствие()
        .Вставить("ТипКоннектора", "КоннекторInMemory")
    );

Поделка = Новый Поделка(СоветДляТестов);
Поделка.ЗапуститьПриложение();

// Создаем схему для тестов
МенеджерСущностей = Поделка.НайтиЖелудь("МенеджерСущностей");
МенеджерСущностей.СоздатьТаблицы();

// Выполняем тесты
ХранилищеПользователей = Поделка.НайтиЖелудь("ХранилищеПользователей");
// ... тестовый код
```

## Интеграция с другими компонентами autumn

### Использование в сервисах

```1c
&Родитель
Перем ХранилищеПользователей;

Функция СоздатьАккаунт(ДанныеПользователя) Экспорт
    // Валидация данных
    Если НЕ ВалидныДанныеПользователя(ДанныеПользователя) Тогда
        ВызватьИсключение "Некорректные данные пользователя";
    КонецЕсли;
    
    // Проверка уникальности email
    СуществующийПользователь = ХранилищеПользователей.НайтиПоEmailРавно(ДанныеПользователя.Email);
    Если СуществующийПользователь <> Неопределено Тогда
        ВызватьИсключение "Пользователь с таким email уже существует";
    КонецЕсли;
    
    // Создание пользователя
    НовыйПользователь = Новый Пользователь();
    НовыйПользователь.Имя = ДанныеПользователя.Имя;
    НовыйПользователь.Email = ДанныеПользователя.Email;
    НовыйПользователь.ХешПароля = ХешировательПаролей.Хешировать(ДанныеПользователя.Пароль);
    
    Возврат ХранилищеПользователей.Создать(НовыйПользователь);
КонецФункции

&Сервис
&Автоподключение
Процедура ПриСозданииОбъекта(&Пластилин("ХранилищеПользователей") ХранилищеПользователей)
    Этот.ХранилищеПользователей = ХранилищеПользователей;
КонецПроцедуры
```

### Использование в контроллерах

```1c
&Родитель
Перем СервисПользователей;

&Get("/пользователи")
Функция СписокПользователей(Запрос, Ответ) Экспорт
    Пользователи = СервисПользователей.ПолучитьВсехПользователей();
    Ответ.JSON(Пользователи);
КонецФункции

&Post("/пользователи")
Функция СоздатьПользователя(Запрос, Ответ) Экспорт
    ДанныеПользователя = Запрос.JSON();
    НовыйПользователь = СервисПользователей.СоздатьАккаунт(ДанныеПользователя);
    Ответ.JSON(НовыйПользователь);
КонецФункции

&Контроллер
&Автоподключение
Процедура ПриСозданииОбъекта(&Пластилин СервисПользователей)
    Этот.СервисПользователей = СервисПользователей;
КонецПроцедуры
```